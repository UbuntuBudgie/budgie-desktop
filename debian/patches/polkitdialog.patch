Description: Resolve polkit dialog crashes
 errors.ubuntu.com reports many polkit crashes
 over many versions of budgie-desktop.
 This is a patch designed to resolve or reduce
 the number of reports. The reports of
 errors.ubuntu.com will continue to be
 monitored to see if this patch is good
 enough to be forwarded upstream
Author: David Mohammed <fossfreedom@ubuntu.com>
Forwarded: no
Last-Update: 2020-03-21

Index: budgie-desktop-10.5.1/src/polkit/polkitdialog.vala
===================================================================
--- budgie-desktop-10.5.1.orig/src/polkit/polkitdialog.vala
+++ budgie-desktop-10.5.1/src/polkit/polkitdialog.vala
@@ -1,8 +1,8 @@
 /*
  * This file is part of budgie-desktop
- * 
+ *
  * Copyright Â© 2015-2019 Budgie Desktop Developers
- * 
+ *
  * This program is free software; you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation; either version 2 of the License, or
@@ -70,7 +70,7 @@ public class AgentDialog : Gtk.Window
     }
 
     /* Manipulate Vala's pointer logic to prevent a copy */
-    public unowned GLib.Cancellable? cancellable { public set ; public unowned get; }
+    public unowned GLib.Cancellable? cancellable { public set ; public get; }
 
     public string cookie { public get; public set; }
 
@@ -215,7 +215,7 @@ public class AgentDialog : Gtk.Window
     /* This bit is inspired by lxpolkit */
     public void set_from_idents(List<Polkit.Identity?> idents)
     {
-        Gtk.ListBoxRow? active_row = null;
+        //Gtk.ListBoxRow? active_row = null;
 
         Gtk.ListStore? model = new Gtk.ListStore(2, typeof(string), typeof(Polkit.Identity));
         Gtk.TreeIter iter;
@@ -236,7 +236,7 @@ public class AgentDialog : Gtk.Window
                 name = ident.to_string();
             }
 
-            
+
             model.append(out iter);
             model.set(iter, 0, name, 1, ident);
             ++length;
@@ -286,6 +286,8 @@ public class Agent : PolkitAgent.Listene
     /* Theme management */
     private Budgie.ThemeManager theme_manager;
 
+    public signal void stopagent ();
+
     public override async bool initiate_authentication(string action_id, string message, string icon_name,
         Polkit.Details details, string cookie, GLib.List<Polkit.Identity?>? identities, GLib.Cancellable cancellable) throws Polkit.Error
     {
@@ -349,7 +351,8 @@ public class Agent : PolkitAgent.Listene
     private void end_session(bool quit)
     {
         if (quit) {
-            Gtk.main_quit();
+            //Gtk.main_quit();
+            stopagent();
             return;
         }
         try {
@@ -373,6 +376,11 @@ public static int main(string[] args)
     Intl.textdomain(Budgie.GETTEXT_PACKAGE);
 
     Budgie.Agent? agent = new Budgie.Agent();
+    agent.stopagent.connect(() => {
+        Gtk.main_quit();
+        return;
+    });
+
     Polkit.Subject? subject = null;
 
     int pid = Posix.getpid();
