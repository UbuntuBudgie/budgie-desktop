Origin: Commit c60c91895215720e7c2628020e370611ed28c5dd
Author: Campbell Jones <git@serebit.com>
Last-Update: Thu, 7 Jan 2021 21:02:28 -0500
Description: Synchronize X errors in carbon_child_realize (#2091)

---
 src/applets/tray/carbontray/child.c | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/src/applets/tray/carbontray/child.c b/src/applets/tray/carbontray/child.c
index 3959af1d..bff4065a 100644
--- a/src/applets/tray/carbontray/child.c
+++ b/src/applets/tray/carbontray/child.c
@@ -98,17 +98,24 @@ bool carbon_child_realize(CarbonChild* self) {
 	GdkWindow* window = gtk_widget_get_window(widget);
 
 	GdkDisplay* display = gtk_widget_get_display(widget);
+	Display* xdisplay = GDK_DISPLAY_XDISPLAY(display);
+
+	// make X calls synchronous for background setting, so that BadWindow errors can be caught
 	gdk_x11_display_error_trap_push(display);
+	XSynchronize(xdisplay, true);
 
 	if (self->isComposited) {
-		XSetWindowBackground(GDK_DISPLAY_XDISPLAY(display), self->iconWindow, 0);
+		XSetWindowBackground(xdisplay, self->iconWindow, 0);
 	} else if (gtk_widget_get_visual(widget) == gdk_window_get_visual(gdk_window_get_parent(window))) {
-		XSetWindowBackgroundPixmap(GDK_DISPLAY_XDISPLAY(display), self->iconWindow, None);
+		XSetWindowBackgroundPixmap(xdisplay, self->iconWindow, None);
 	} else {
 		self->parentRelativeBg = FALSE;
 	}
 
+	// make X calls asynchronous again, all errors have already been trapped
+	XSynchronize(xdisplay, false);
 	int error = gdk_x11_display_error_trap_pop(display);
+
 	if (error != 0) {
 		g_warning("Encountered X error %d when setting background for tray icon", error);
 		return false;
@@ -168,7 +175,7 @@ static void carbon_child_class_init(CarbonChildClass* klass) {
 }
 
 static bool set_wmclass(CarbonChild* self, Display* xdisplay) {
-	XClassHint ch = {};
+	XClassHint ch = {0};
 
 	GdkDisplay* display = gdk_display_get_default();
 	gdk_x11_display_error_trap_push(display);
-- 
2.27.0

