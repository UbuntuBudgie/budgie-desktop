#!/usr/bin/make -f
export DH_VERBOSE = 1
export MAKE = ninja -v

# rules below are required due to budgie-desktop not running
# correctly with a standard debhelper rules set
# https://github.com/UbuntuBudgie/budgie-desktop/pull/2

clean:
	rm -rf debian/build
ifeq ($(shell dpkg-vendor --derives-from Ubuntu && echo ubuntu),ubuntu)

	@if [ -e ./debian/ubuntu/applied ]; then \
		patch -R -p1 < debian/ubuntu/show_nm-applet_in_tray.patch ; \
		rm ./debian/ubuntu/applied ; \
	fi

endif
	dh_clean

build build-arch:
ifeq ($(shell dpkg-vendor --derives-from Ubuntu && echo ubuntu),ubuntu)
	patch -p1 < debian/ubuntu/show_nm-applet_in_tray.patch
	touch ./debian/ubuntu/applied
endif
	mkdir -p debian/build
	cd debian/build && LDFLAGS="-Wl,-z,now -Wl,-z,relro" meson --buildtype plain --prefix=/usr --libdir=/usr/lib --sysconfdir=/etc ../..
	cd debian/build && $(MAKE)

binary binary-arch:
	dh_testroot
	cd debian/build && DESTDIR=$(CURDIR)/debian/tmp $(MAKE) install
	dh_auto_install
	dh_install
	dh_installman debian/budgie-desktop.1
	dh_installman debian/budgie-panel.1
	dh_installman debian/budgie-polkit-dialog.1
	dh_installman debian/budgie-run-dialog.1
	dh_installman debian/budgie-wm.1
	dh_installman debian/budgie-daemon.1
	dh_installdocs
	dh_installchangelogs
	dh_lintian
	dh_compress
	# remove unneeded build files
	find debian -name \*.la -exec rm {} \;
	find debian -name \*.a -exec rm {} \;
	# correct permissions on build shared object libraries
	find debian -name \*.so* -exec chmod 644 {} \;
	# correct permissions on gtk-doc generated files
	find debian -name \*.html -exec chmod 644 {} \;
	# correct permissions on folders
	find ./debian -type d | xargs chmod 755
	# remove unrecognised and non ISO639 locale
	find debian -type d -name "zh-Hant" -print0 | xargs -r0 -- rm -r
	# install override but budgie has to take precedence over
	# gnome-shell defaults
	dh_installgsettings --priority=15
	dh_fixperms
	dh_strip -p budgie-core
	dh_strip -p libbudgie-plugin0
	dh_strip -p libbudgietheme0
	dh_strip -p libraven0
	dh_makeshlibs
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

%:
	dh $@
